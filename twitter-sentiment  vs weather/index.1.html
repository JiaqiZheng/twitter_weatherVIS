<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Twitter Sentiment</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style>

       

        .graph-svg-component {
            background-color: AliceBlue;
        }

        .y-axis path,
        .y-axis line {
            fill: none;
            stroke: black;
            shape-rendering: crispEdges;
        }
        .y-axis text {
            font-family: sans-serif;
        }
        
        .x-axis path,
        .x-axis line {
            fill: none;
            stroke: black;
            shape-rendering: crispEdges;
        }

        .x-axis text {
            font-family: sans-serif;
        }
        .toolTip {
            position: absolute;
            display: none;
            min-width: 80px;
            height: auto;
            background: none repeat scroll 0 0 #ffffff;
            border: 1px solid #6F257F;
            padding: 14px;
            text-align: center;
            }
    </style>
  </head>
  <body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>
    <script type="text/javascript">
        function refreshPage(){
          window.location.reload();
        }
    </script>
    <object type="image/svg+xml" data="us.svg" id="map">
    </object>
    <div id="chart" style="position: fixed; top: 0px; left: 0px"></div>
    <div id="tool" style="position: fixed; top: 100px; left: 1000px">
      <select id="thedropdown" onchange="refreshPage()">
        <option value="0">Average Temperature</option>
        <option value="1">Maximum Temperature</option>
        <option value="2">Minimum Temperature</option>
      </select>
      <div id="color-bar-scale"></div>
    </div>

    <script>
        var tooltip = d3.select("body").append("div").attr("class", "toolTip");
        var states=[ "AK","AL","AR","AZ","CA","CO","CT","DE",
                    "FL","GA","HI","IA","ID","IL","IN","KS",
                    "KY", "LA", "MA", "MD", "ME", "MI", "MN", "MO", 
                    "MS", "MT", "NC", "ND", "NE","NH", "NJ", "NM", 
                    "NV", "NY", "OH", "OK", "OR", "PA",  "RI", "SC",
                    "SD", "TN","TX","UT","VA", "VT", "WA", "WI",
                    "WV", "WY"]
        //get a rough location data from svg
        var mapsvg = document.getElementById("map");
        var x=[];
        var y=[];
        mapsvg.addEventListener("load",function(){
            for (n=0; n<states.length;n++){
                var svgDoc = mapsvg.contentDocument;
                var pathpicked = svgDoc.getElementById(states[n]);
                var svgd=pathpicked.getAttribute("d");
                x.push(parseFloat(svgd.charAt(2)+svgd.charAt(3)+svgd.charAt(4)+svgd.charAt(5)+svgd.charAt(6)));
                y.push(parseFloat(svgd.charAt(12)+svgd.charAt(13)+svgd.charAt(14)+svgd.charAt(15)+svgd.charAt(16)));
            }
            d3.json("state_date_sent-more-more.json", function(error, data) {
            
                //read sentiment data
                var scores = [[],[],[],[],[],[],[],[],[],[],
                    [],[],[],[],[],[],[],[],[],[],
                    [],[],[],[],[],[],[],[],[],[],
                    [],[],[],[],[],[],[],[],[],[],
                    [],[],[],[],[],[],[],[],[],[]];
                var counts = [[],[],[],[],[],[],[],[],[],[],
                    [],[],[],[],[],[],[],[],[],[],
                    [],[],[],[],[],[],[],[],[],[],
                    [],[],[],[],[],[],[],[],[],[],
                    [],[],[],[],[],[],[],[],[],[]];
                data.forEach(function(d) {
                    for (i = 0; i < states.length; i++) {
    
                        if (d.state == states[i]){
                            scores[i].push(d.score);
                            counts[i].push(d.count);
                        }
                    };
                });
                console.log(scores);

                //read weather data
                var a = document.getElementById("thedropdown");
                var weather_type = a.value;
                var typename = ["Avg T","Max T","Min T"]
                d3.csv("weather-all.csv", function(data){
                    var weather = [[],[],[],[],[],[],[],[],[],[],
                    [],[],[],[],[],[],[],[],[],[],
                    [],[],[],[],[],[],[],[],[],[],
                    [],[],[],[],[],[],[],[],[],[],
                    [],[],[],[],[],[],[],[],[],[]];

                        data.forEach(function(d){
                        for(var i=0; i<states.length; i++) {
                            if (d.state==states[i]){
                                if (weather_type==0){
                                    weather[i].push(parseFloat(d.AVGT));
                                }
                                if (weather_type==1){
                                    weather[i].push(parseFloat(d.MAXT));
                                }
                                if (weather_type==2){
                                    weather[i].push(parseFloat(d.MINT));
                                }
                            }
                          }
                        });  
                        console.log(weather);

                    render_barchart();
                    //adjust the positions of barcharts
                    var offsetx = new Array(50).fill(0);
                    var offsety = new Array(50).fill(0);
                    var rsize = new Array(50).fill(0.3);
                    offsetx[0]=90;offsety[0]=-70;rsize[0]=0.7//AK
                    offsetx[1]=25;offsety[1]=30;rsize[1]=0.3//AL
                    offsetx[2]=-40;offsety[2]=20;rsize[2]=0.3//AR
                    offsetx[3]=-35;offsety[3]=50;rsize[3]=0.3//AZ
                    offsetx[4]=-10;offsety[4]=-90;rsize[4]=0.4//CA
                    offsetx[5]=-60;offsety[5]=0;rsize[5]=0.6//CO
                    offsetx[6]=0;offsety[6]=15;rsize[6]=0.1//CT 
                    offsetx[7]=55;offsety[7]=30;rsize[7]=0.2//DE OUT
                    offsetx[8]=5;offsety[8]=-70;rsize[8]=0.3///FL
                    offsetx[9]=-30;offsety[9]=-30;rsize[9]=0.3//GA
                    //HI
                    offsetx[11]=-40;offsety[11]=0;rsize[11]=0.3//IA
                    offsetx[12]=10;offsety[12]=100;rsize[12]=0.3//ID
                    offsetx[13]=20;offsety[13]=40;rsize[13]=0.3//IL
                    offsetx[14]=-10;offsety[14]=20;rsize[14]=0.3//IN
                    offsetx[15]=-30;offsety[15]=-30;rsize[15]=0.3//KS
                    offsetx[16]=70;offsety[16]=-45;rsize[16]=0.3//KY
                    offsetx[17]=-35;offsety[17]=-40;rsize[17]=0.3//LA
                    offsetx[18]=0;offsety[18]=-15;rsize[18]=0.1//MA 
                    offsetx[19]=50;offsety[19]=30;rsize[19]=0.2//MD OUT
                    offsetx[20]=5;offsety[20]=30;rsize[20]=0.3//MN
                    offsetx[21]=35;offsety[21]=10;rsize[21]=0.3//MI
                    offsetx[22]=35;offsety[22]=30;rsize[22]=0.3//MN
                    offsetx[23]=-10;offsety[23]=40;rsize[23]=0.3//MO
                    offsetx[24]=-20;offsety[24]=-60;rsize[24]=0.3//MS
                    offsetx[25]=-100;offsety[25]=10;//MT
                    offsetx[26]=-10;offsety[26]=-30;//NC
                    offsetx[27]=-30;offsety[27]=10;//ND
                    offsetx[28]=-30;offsety[28]=10;//NE
                    offsetx[29]=15;offsety[29]=40;rsize[29]=0.1//NH 
                    offsetx[30]=0;offsety[30]=-20;rsize[30]=0.2//NJ 
                    offsetx[31]=-50;offsety[31]=30;//NM
                    offsetx[32]=-30;offsety[32]=-50;//NV
                    offsetx[33]=-50;offsety[33]=-60;//NY
                    offsetx[34]=-20;offsety[34]=5;//OH
                    offsetx[35]=-30;offsety[35]=10;//OK
                    offsetx[36]=50;offsety[36]=50;//OR
                    offsetx[37]=-50;offsety[37]=20;//PA
                    offsetx[38]=20;offsety[38]=30;rsize[38]=0.2//RI OUT
                    offsetx[39]=65;offsety[39]=10;//SC
                    offsetx[40]=-30;offsety[40]=10;//SD
                    offsetx[41]=-50;offsety[41]=15;//TN
                    offsetx[42]=-30;offsety[42]=-130;rsize[42]=0.7///TX
                    offsetx[43]=0;offsety[43]=60;//UT
                    offsetx[44]=-20;offsety[44]=-20;//VA
                    offsetx[45]=-5;offsety[45]=-30;rsize[45]=0.1//VT
                    offsetx[46]=50;offsety[46]=-20;//WA
                    offsetx[47]=-30;offsety[47]=10;//WV
                    offsetx[48]=-5;offsety[48]=15;//WV
                    offsetx[49]=-50;offsety[49]=0;//WY

                    //generate 50 barcharts
                    for (k=0; k<50;k++){
                                render_bars(states[k],weather[k], rsize[k], scores[k],counts[k],x[k]+offsetx[k],y[k]+offsety[k],typename[weather_type]);
                        }
                    })
            });

        }, false);

        

    var render_barchart = function(){
            //create canvas
            var Canvas = d3.select('#chart')
                            .append('svg')
                            .attr('width', 1000)
					        .attr('height', 1000)
    };
    var render_bars = function(State, weather, rSize, score,count,X,Y,typename){
            var date=["Mar-3","Mar-4","Mar-5","Mar-6","Mar-7"];
            var CA_x = X;
            var CA_y = Y;

            var H=100;
            var W=100;
            var size = rSize;

			var height = H*size;
			var width = W*size;

			var yScale = d3.scale.linear()
				.domain([0, 100])
				.range([0, height]);
			var xScale = d3.scale.ordinal()
				.domain(d3.range(0, weather.length))
				.rangeBands([0, width])
            var vScale = d3.scale.linear()
				.domain([0, 100])
				.range([height, 0]);
			var hScale = d3.scale.ordinal()
				.domain(d3.range(0, weather.length))
				.range([0, width])

            var yScaleS = d3.scale.linear()
				.domain([-1, 1])
				.range([0, height]);
            var vScaleS = d3.scale.linear()
				.domain([-1, 1])
				.range([height, height*2]);

            var colors1 = d3.scale.linear()
				.domain([50, 100])
				.range([d3.rgb(0.865*255, 0.865*255, 0.865*255), d3.rgb(0.706*255, 0.016*255, 0.150*255)])
            var colors2 = d3.scale.linear()
				.domain([0, 50])
				.range([d3.rgb(0.230*255, 0.299*255, 0.754*255), d3.rgb(0.865*255, 0.865*255, 0.865*255)])

            var colors1s = d3.scale.linear()
				.domain([0,1])
				.range([d3.rgb(0.865*255, 0.865*255, 0.865*255), d3.rgb(0.759*255, 0.334*255, 0.046*255)])
            var colors2s = d3.scale.linear()
				.domain([-1,0])
				.range([d3.rgb(0.436*255, 0.308*255, 0.631*255), d3.rgb(0.865*255, 0.865*255, 0.865*255)])
           
            var vAxis = d3.svg.axis()
				.scale(vScale)
				.orient('left')
				.ticks(2)

            var vAxisS = d3.svg.axis()
				.scale(vScaleS)
				.orient('left')
				.ticks(2)

            // H Axis
			var hAxis = d3.svg.axis()
				.scale(hScale)
				.orient('bottom')
                .tickFormat("")

            //create bars
			var graph = d3.select('svg')
                        .append('g')
                        .attr('transform', 'translate('+CA_x+','+CA_y+')')
                        .on('click', function(d, i) {
                          d3.select(this).attr('transform', 'translate('+CA_x+','+CA_y+') scale(2)')
                        })
                        .on('dblclick', function(d, i) {
                          d3.select(this).attr('transform', 'translate('+CA_x+','+CA_y+') scale(1)')
                        })


            var bars = graph.append('g')
                bars.selectAll('rect')
                            .data(weather)
                            .enter()
                            .append('rect')
                            .style('fill', function(d, i){
                                        if (weather[i]>=50){return colors1(weather[i])}
                                        else {return colors2(weather[i])}
                                })
                            .attr('width', xScale.rangeBand()*0.8)
                            .attr('height', function(d, i){
                                    return yScale(d);
                                })
                            .attr('x', function(d, i){
                                    return xScale(i);
                                })
                            .attr('y', function(d, i){
                                    return height - yScale(d)
                                })
                                .on("mousemove", function(d,i){
                                    tooltip
                                    .style("left", d3.event.pageX - 50 + "px")
                                    .style("top", d3.event.pageY - 70 + "px")
                                    .style("display", "inline-block")
                                    .html((State) + "<br>" + "#Temp(F): " + parseInt(weather[i]));
                                    
                                })
                                .on("mouseout", function(d){ tooltip.style("display", "none");});
                                
                var yAxes =bars.append('g')
                    .style("font", "8px times")
                    .attr("class", "y-axis") 
                    .call(vAxis)

                var xAxes = bars.append('g')
                    .attr("class", "x-axis") 
                    .attr("transform", "translate(0," + width + ")")
                    .call(hAxis)
            
                bars.append("text")      // text label for the x axis
                    .style("font", "8px times")
                    .attr("x", width/2 )
                    .attr("y",  0 )
                    .style("text-anchor", "middle")
                    .text(typename);


            /* Sentiment */
            
            var barsS = graph.append('g')
                barsS.selectAll('rect')
                            .data(score)
                            .enter()
                            .append('rect')
                            .style('fill', function(d, i){
                                        if (score[i]>=0){return colors1s(score[i])}
                                        else {return colors2s(score[i])}
                                })
                            .attr('width', xScale.rangeBand()*0.8)
                            .attr('height', function(d, i){
                                if(count[i]>0) {return yScaleS(d);}
                                else {return 0}
                                })
                            .attr('x', function(d, i){
                                    return xScale(i);
                                })
                            .attr('y', function(d, i){
                                    return height
                                })
                                .on("mousemove", function(d,i){
                                    tooltip
                                    .style("left", d3.event.pageX - 50 + "px")
                                    .style("top", d3.event.pageY - 70 + "px")
                                    .style("display", "inline-block")
                                    .html((State) + "<br>" + "#Tweets: " + count[i]);
                                    
                                })
                                .on("mouseout", function(d){ tooltip.style("display", "none");});
                                
                var yAxesS =barsS.append('g')
                    .style("font", "8px times")
                    .attr("class", "y-axis") 
                    .call(vAxisS)

                var xAxesS = barsS.append('g')
                    .attr("class", "x-axis") 
                    .attr("transform", "translate(0," + width + ")")
                    .call(hAxis)
                    
                bars.append("text")      // text label for the x axis
                    .style("font", "8px times")
                    .attr("x", width/2 )
                    .attr("y",  height*2 )
                    .style("text-anchor", "middle")
                    .text("Sentiment");

            
		};

        /* color scale*/
        var CanvasColorScale = d3.select('#color-bar-scale')
                    .append('svg')
                    .attr('id',"color-scale")
                    //.attr('position',inhert)
                    .attr('width', 200)
					.attr('height', 200)
                    var defs = CanvasColorScale.append("defs")
        var gradient = defs.append("linearGradient")
                        .attr("id", "svgGradient")
                        .attr("x1", "0%")
                        .attr("x2", "100%")
                        //.attr("y1", "0%")
                        //.attr("y2", "100%");
        gradient.append("stop")
                .attr('class', 'start')
                .attr("offset", "0%")
                .attr("stop-color", d3.rgb(0.230*255, 0.299*255, 0.754*255))
                .attr("stop-opacity", 1);

        gradient.append("stop")
                .attr('class', 'middle')
                .attr("offset", "50%")
                .attr("stop-color", d3.rgb(0.865*255, 0.865*255, 0.865*255))
                .attr("stop-opacity", 1);

        gradient.append("stop")
                .attr('class', 'end')
                .attr("offset", "100%")
                .attr("stop-color", d3.rgb(0.706*255, 0.016*255, 0.150*255))
                .attr("stop-opacity", 1);
                    
        var ColorScale = CanvasColorScale.append('rect')
                    .style('fillStyle','grd')
                    .style('fill', "url(#svgGradient)")
                    .attr('width',200)
                    .attr('height',30)
                    .attr('x',1)
                    .attr('y',65)
        var ColorScaleLabel1 = CanvasColorScale.append('text')
                    .attr("x", 1)
                    .attr("y", 55)
                    .attr("dy", ".35em")
                    .text("0")
        var ColorScaleLabel2 = CanvasColorScale.append('text')
                    .attr("x", 175)
                    .attr("y", 55)
                    .attr("dy", ".35em")
                    .text("100")
        var ColorScaleLabel2 = CanvasColorScale.append('text')
                    .attr("x", 60)
                    .attr("y", 55)
                    .attr("dy", ".35em")
                    .text("Temperature")
        
        var gradients = defs.append("linearGradient")
                        .attr("id", "svgGradients")
                        .attr("x1", "0%")
                        .attr("x2", "100%")
                        //.attr("y1", "0%")
                        //.attr("y2", "100%");
        gradients.append("stop")
                .attr('class', 'start')
                .attr("offset", "0%")
                .attr("stop-color", d3.rgb(0.436*255, 0.308*255, 0.631*255))
                .attr("stop-opacity", 1);

        gradients.append("stop")
                .attr('class', 'middle')
                .attr("offset", "50%")
                .attr("stop-color", d3.rgb(0.865*255, 0.865*255, 0.865*255))
                .attr("stop-opacity", 1);

        gradients.append("stop")
                .attr('class', 'end')
                .attr("offset", "100%")
                .attr("stop-color", d3.rgb(0.759*255, 0.334*255, 0.046*255))
                .attr("stop-opacity", 1);
                        
        var ColorScales = CanvasColorScale.append('rect')
                    .style('fillStyle','grd')
                    .style('fill', "url(#svgGradients)")
                    .attr('width',200)
                    .attr('height',30)
                    .attr('x',1)
                    .attr('y',120)
        var ColorScaleLabel1 = CanvasColorScale.append('text')
                    .attr("x", 1)
                    .attr("y", 110)
                    .attr("dy", ".35em")
                    .text("-1")
        var ColorScaleLabel2 = CanvasColorScale.append('text')
                    .attr("x", 190)
                    .attr("y", 110)
                    .attr("dy", ".35em")
                    .text("1")
        var ColorScaleLabel2 = CanvasColorScale.append('text')
                    .attr("x", 70)
                    .attr("y", 110)
                    .attr("dy", ".35em")
                    .text("Sentiment")

    </script>
  </body>
</html>
