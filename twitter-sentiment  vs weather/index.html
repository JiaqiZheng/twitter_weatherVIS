<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Twitter Sentiment</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style>

        .graph-svg-component {
            background-color: AliceBlue;
        }

        .y-axis path,
        .y-axis line {
            fill: none;
            stroke: black;
            shape-rendering: crispEdges;
        }
        .y-axis text {
            font-family: sans-serif;
        }
        
        .x-axis path,
        .x-axis line {
            fill: none;
            stroke: black;
            shape-rendering: crispEdges;
        }

        .x-axis text {
            font-family: sans-serif;
        }
        .toolTip {
            position: absolute;
            display: none;
            min-width: 80px;
            height: auto;
            background: none repeat scroll 0 0 #ffffff;
            border: 1px solid #6F257F;
            padding: 14px;
            text-align: center;
            }
    </style>
  </head>
  <body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>
    <script type="text/javascript">
        function refreshPage(){
          window.location.reload();
        }
    </script>
    <object type="image/svg+xml" data="us_label.svg" id="map" style="position: fixed; top: 100px; left: 200px; width: 981px; height: 588px;">
    </object>
    <div id="title" style="position: fixed; left: 200px; ">
        <h1>
            United States Temperature-Sentiment Map (March)
        </h1>
    </div>
    <div id="chart" style="position: fixed; top: 50px; left: 150px; width: 1200px; height: 600px; "></div>
    <div id="tool" style="position: fixed; top: 100px; left: 0px">
      <select style="position: fixed; top: 100px; width: 200px" id="thedropdown" onchange="refreshPage()">
        <option value="0">Average Temperature</option>
        <option value="1">Maximum Temperature</option>
        <option value="2">Minimum Temperature</option>
      </select>
      <div id="color-bar-scale"></div>
    </div>

    <script>
        var tooltip = d3.select("body").append("div").attr("class", "toolTip");
        var states=[ "AK","AL","AR","AZ","CA","CO","CT","DE",
                    "FL","GA","HI","IA","ID","IL","IN","KS",
                    "KY", "LA", "MA", "MD", "ME", "MI", "MN", "MO", 
                    "MS", "MT", "NC", "ND", "NE","NH", "NJ", "NM", 
                    "NV", "NY", "OH", "OK", "OR", "PA",  "RI", "SC",
                    "SD", "TN","TX","UT","VA", "VT", "WA", "WI",
                    "WV", "WY"]
        //get a rough location data from svg
        var mapsvg = document.getElementById("map");
        var x=[];
        var y=[];
        mapsvg.addEventListener("load",function(){
            for (n=0; n<states.length;n++){
                var svgDoc = mapsvg.contentDocument;
                var pathpicked = svgDoc.getElementById(states[n]);
                var svgd=pathpicked.getAttribute("d");
                x.push(parseFloat(svgd.charAt(2)+svgd.charAt(3)+svgd.charAt(4)+svgd.charAt(5)+svgd.charAt(6)));
                console.log(states[n]);
                y.push(parseFloat(svgd.charAt(12)+svgd.charAt(13)+svgd.charAt(14)+svgd.charAt(15)+svgd.charAt(16)));
            }
            d3.json("state_date_sent-more-more.json", function(error, data) {
            
                //read sentiment data
                var scores = [[],[],[],[],[],[],[],[],[],[],
                    [],[],[],[],[],[],[],[],[],[],
                    [],[],[],[],[],[],[],[],[],[],
                    [],[],[],[],[],[],[],[],[],[],
                    [],[],[],[],[],[],[],[],[],[]];
                var counts = [[],[],[],[],[],[],[],[],[],[],
                    [],[],[],[],[],[],[],[],[],[],
                    [],[],[],[],[],[],[],[],[],[],
                    [],[],[],[],[],[],[],[],[],[],
                    [],[],[],[],[],[],[],[],[],[]];
                data.forEach(function(d) {
                    for (i = 0; i < states.length; i++) {
    
                        if (d.state == states[i]){
                            scores[i].push(d.score);
                            counts[i].push(d.count);
                        }
                    };
                });
                console.log(scores);

                //read weather data
                var a = document.getElementById("thedropdown");
                var weather_type = a.value;
                var typename = ["Avg T","Max T","Min T"]
                d3.csv("weather-all.csv", function(data){
                    var weather = [[],[],[],[],[],[],[],[],[],[],
                    [],[],[],[],[],[],[],[],[],[],
                    [],[],[],[],[],[],[],[],[],[],
                    [],[],[],[],[],[],[],[],[],[],
                    [],[],[],[],[],[],[],[],[],[]];

                        data.forEach(function(d){
                        for(var i=0; i<states.length; i++) {
                            if (d.state==states[i]){
                                if (weather_type==0){
                                    weather[i].push(parseFloat(d.AVGT));
                                }
                                if (weather_type==1){
                                    weather[i].push(parseFloat(d.MAXT));
                                }
                                if (weather_type==2){
                                    weather[i].push(parseFloat(d.MINT));
                                }
                            }
                          }
                        });  
                        console.log(weather);

                    render_barchart();
                    //adjust the positions of barcharts
                    var offsetx = new Array(50).fill(0);
                    var offsety = new Array(50).fill(0);
                    var rsize = new Array(50).fill(0.3);
                    offsetx[0]=40;offsety[0]=60;//AK
                    offsetx[1]=60;offsety[1]=-20;//AL
                    offsetx[2]=0;offsety[2]=50;//AR
                    offsetx[3]=100;offsety[3]=30;//AZ
                    offsetx[4]=-30;offsety[4]=-100;//CA
                    offsetx[5]=0;offsety[5]=50;//CO
                    offsetx[6]=50;offsety[6]=70;//CT 
                    offsetx[7]=120;offsety[7]=70;//DE
                    offsetx[8]=50;offsety[8]=80;///FL
                    offsetx[9]=60;offsety[9]=100;//GA
                    offsetx[10]=120;offsety[10]=30;//HI
                    offsetx[11]=0;offsety[11]=40;//IA
                    offsetx[12]=60;offsety[12]=-20;//ID
                    offsetx[13]=20;offsety[13]=-40;//IL
                    offsetx[14]=60;offsety[14]=-20;//IN
                    offsetx[15]=0;offsety[15]=0;//KS
                    offsetx[16]=0;offsety[16]=20;//KY
                    offsetx[17]=-20;offsety[17]=20;//LA
                    offsetx[18]=-170;offsety[18]=-60;//MA 
                    offsetx[19]=20;offsety[19]=20;//MD
                    offsetx[20]=0;offsety[20]=0;//ME
                    offsetx[21]=120;offsety[21]=100;//MI
                    offsetx[22]=80;offsety[22]=0;//MN
                    offsetx[23]=-80;offsety[23]=50;//MO
                    offsetx[24]=0;offsety[24]=-20;//MS
                    offsetx[25]=0;offsety[25]=0;//MT
                    offsetx[26]=0;offsety[26]=60;//NC
                    offsetx[27]=-20;offsety[27]=-20;//ND
                    offsetx[28]=-30;offsety[28]=10;//NE
                    offsetx[29]=30;offsety[29]=20;//NH 
                    offsetx[30]=50;offsety[30]=50;//NJ 
                    offsetx[31]=50;offsety[31]=0;//NM
                    offsetx[32]=30;offsety[32]=100;//NV
                    offsetx[33]=0;offsety[33]=0;//NY
                    offsetx[34]=0;offsety[34]=50;//OH
                    offsetx[35]=120;offsety[35]=80;//OK
                    offsetx[36]=-20;offsety[36]=-20;//OR
                    offsetx[37]=-20;offsety[37]=20;//PA
                    offsetx[38]=80;offsety[38]=20;//RI
                    offsetx[39]=65;offsety[39]=10;//SC
                    offsetx[40]=-30;offsety[40]=-20;//SD
                    offsetx[41]=-30;offsety[41]=50;//TN
                    offsetx[42]=150;offsety[42]=150;///TX
                    offsetx[43]=0;offsety[43]=-20;//UT
                    offsetx[44]=0;offsety[44]=30;//VA
                    offsetx[45]=20;offsety[45]=-20;//VT
                    offsetx[46]=20;offsety[46]=-20;//WA
                    offsetx[47]=0;offsety[47]=-50;//WI
                    offsetx[48]=20;offsety[48]=50;//WV
                    offsetx[49]=0;offsety[49]=80;//WY

                    //generate 50 barcharts
                    for (k=0; k<50;k++){
                        render_bars(states[k],weather[k], rsize[k], scores[k],counts[k],x[k]+offsetx[k],y[k]+offsety[k],typename[weather_type]);
                        }
                    })
            });

        }, false);

        

    var render_barchart = function(){
            //create canvas
            var Canvas = d3.select('#chart')
                            .append('svg')
                            .attr('width', 1000)
					        .attr('height', 1000)
    };
    var render_bars = function(State, weather, rSize, score,count,X,Y,typename){
            var date=["Mar-3","Mar-4","Mar-5","Mar-6","Mar-7"];
            var CA_x = X;
            var CA_y = Y;

            var H=100;
            var W=100;
            var size = rSize;

			var height = H*size;
			var width = W*size;

			var yScale = d3.scale.linear()
				.domain([0, 80])
				.range([0, height]);
			var xScale = d3.scale.ordinal()
				.domain(d3.range(0, weather.length))
				.rangeBands([0, width])
            var vScale = d3.scale.linear()
				.domain([0, 80])
				.range([height, 0]);
			var hScale = d3.scale.ordinal()
				.domain(d3.range(0, weather.length))
				.range([0, width])

            var yScaleS = d3.scale.linear()
				.domain([-1, 1])
				.range([0, height]);
            var vScaleS = d3.scale.linear()
				.domain([-1, 1])
				.range([height, height*2]);

            var colors1 = d3.scale.linear()
				.domain([40, 80])
				.range([d3.rgb(227,105,5), d3.rgb(100,0,0)])
            var colors2 = d3.scale.linear()
				.domain([0, 40])
				.range([d3.rgb(255,255,255), d3.rgb(227,105,5)])

            var colors1s = d3.scale.linear()
				.domain([0,1])
				.range([d3.rgb(221,221,221), d3.rgb(177,1,39)])
            var colors2s = d3.scale.linear()
				.domain([-1,0])
				.range([d3.rgb(85,72,193), d3.rgb(221,221,221)])
             
            var vAxis = d3.svg.axis()
				.scale(vScale)
				.orient('left')
				.ticks(0)

            var vAxisS = d3.svg.axis()
				.scale(vScaleS)
				.orient('left')
				.ticks(0)


            // H Axis
			var hAxis = d3.svg.axis()
				.scale(hScale)
				.orient('bottom')
                .tickFormat("")

            //create bars
			var graph = d3.select('svg')
                        .append('g')
                        .attr('transform', 'translate('+CA_x+','+CA_y+')')
                        .on('click', function(d, i) {
                          d3.select(this).attr('transform', 'translate('+CA_x+','+CA_y+') scale(2)')
                        })
                        .on('dblclick', function(d, i) {
                          d3.select(this).attr('transform', 'translate('+CA_x+','+CA_y+') scale(1)')
                        })
 

            var bars = graph.append('g')
                bars.selectAll('rect')
                            .data(weather)
                            .enter()
                            .append('rect')
                            .style('fill', function(d, i){
                                        if (weather[i]>=40){return colors1(weather[i])}
                                        else {return colors2(weather[i])}
                                })
                            .attr('width', xScale.rangeBand()*0.8)
                            .attr('height', function(d, i){
                                    return yScale(d);
                                })
                            .attr('x', function(d, i){
                                    return xScale(i);
                                })
                            .attr('y', function(d, i){
                                    return height - yScale(d)
                                })
                                .on("mousemove", function(d,i){
                                    tooltip
                                    .style("left", d3.event.pageX - 50 + "px")
                                    .style("top", d3.event.pageY - 70 + "px")
                                    .style("display", "inline-block")
                                    .html((State) + "<br>" + "#Temp(F): " + parseInt(weather[i]));
                                    
                                })
                                .on("mouseout", function(d){ tooltip.style("display", "none");});
                                
                var yAxes =bars.append('g')
                    .style("font", "8px times")
                    .attr("class", "y-axis") 
                    .call(vAxis)

                var xAxes = bars.append('g')
                    .attr("class", "x-axis") 
                    .attr("transform", "translate(0," + width + ")")
                    .call(hAxis)
            
                bars.append("text")      // text label for the x axis
                    .style("font", "8px times")
                    .attr("x", width/2 )
                    .attr("y",  height/4 )
                    .style("text-anchor", "middle")
                    .text(states[k]);


            /* Sentiment */
            
            var barsS = graph.append('g')
                barsS.selectAll('rect')
                            .data(score)
                            .enter()
                            .append('rect')
                            .style('fill', function(d, i){
                                        if (score[i]>=0){return colors1s(score[i])}
                                        else {return colors2s(score[i])}
                                })
                            .attr('width', xScale.rangeBand()*0.8)
                            .attr('height', function(d, i){
                                if(count[i]>0) {return yScaleS(d);}
                                else {return 0}
                                })
                            .attr('x', function(d, i){
                                    return xScale(i);
                                })
                            .attr('y', function(d, i){
                                    return height
                                })
                                .on("mousemove", function(d,i){
                                    tooltip
                                    .style("left", d3.event.pageX - 50 + "px")
                                    .style("top", d3.event.pageY - 70 + "px")
                                    .style("display", "inline-block")
                                    .html((State) + "<br>" + "#Tweets: " + count[i]);
                                    
                                })
                                .on("mouseout", function(d){ tooltip.style("display", "none");});
                                
                var yAxesS =barsS.append('g')
                    .style("font", "8px times")
                    .attr("class", "y-axis") 
                    .call(vAxisS)

                var xAxesS = barsS.append('g')
                    .attr("class", "x-axis") 
                    .attr("transform", "translate(0," + width + ")")
                    .call(hAxis)
        
		};

        /* color scale*/
        var CanvasColorScale = d3.select('#color-bar-scale')
                    .append('svg')
                    .attr('id',"color-scale")
                    //.attr('position',inhert)
                    .attr('width', 200)
					.attr('height', 200)
                    var defs = CanvasColorScale.append("defs")
        var gradient = defs.append("linearGradient")
                        .attr("id", "svgGradient")
                        .attr("x1", "0%")
                        .attr("x2", "100%")
                        //.attr("y1", "0%")
                        //.attr("y2", "100%");
        gradient.append("stop")
                .attr('class', 'start')
                .attr("offset", "0%")
                .attr("stop-color", d3.rgb(255,255,255))
                .attr("stop-opacity", 1);

        gradient.append("stop")
                .attr('class', 'middle')
                .attr("offset", "50%")
                .attr("stop-color", d3.rgb(227,105,5))
                .attr("stop-opacity", 1);

        gradient.append("stop")
                .attr('class', 'end')
                .attr("offset", "100%")
                .attr("stop-color", d3.rgb(100,0,0))
                .attr("stop-opacity", 1);
                    
        var ColorScale = CanvasColorScale.append('rect')
                    .style('fillStyle','grd')
                    .style('fill', "url(#svgGradient)")
                    .attr('width',200)
                    .attr('height',30)
                    .attr('x',1)
                    .attr('y',65)
        var ColorScaleLabel1 = CanvasColorScale.append('text')
                    .attr("x", 1)
                    .attr("y", 55)
                    .attr("dy", ".35em")
                    .text("0")
        var ColorScaleLabel2 = CanvasColorScale.append('text')
                    .attr("x", 180)
                    .attr("y", 55)
                    .attr("dy", ".35em")
                    .text("80")
        var ColorScaleLabel2 = CanvasColorScale.append('text')
                    .attr("x", 60)
                    .attr("y", 55)
                    .attr("dy", ".35em")
                    .text("Temperature")
        
        var gradients = defs.append("linearGradient")
                        .attr("id", "svgGradients")
                        .attr("x1", "0%")
                        .attr("x2", "100%")
                        //.attr("y1", "0%")
                        //.attr("y2", "100%");
        gradients.append("stop")
                .attr('class', 'start')
                .attr("offset", "0%")
                .attr("stop-color", d3.rgb(85,72,193))
                .attr("stop-opacity", 1);

        gradients.append("stop")
                .attr('class', 'middle')
                .attr("offset", "50%")
                .attr("stop-color", d3.rgb(221,221,221))
                .attr("stop-opacity", 1);

        gradients.append("stop")
                .attr('class', 'end')
                .attr("offset", "100%")
                .attr("stop-color", d3.rgb(177,1,39))
                .attr("stop-opacity", 1);
                    
        var ColorScales = CanvasColorScale.append('rect')
                    .style('fillStyle','grd')
                    .style('fill', "url(#svgGradients)")
                    .attr('width',200)
                    .attr('height',30)
                    .attr('x',1)
                    .attr('y',120)
        var ColorScaleLabel1 = CanvasColorScale.append('text')
                    .attr("x", 1)
                    .attr("y", 110)
                    .attr("dy", ".35em")
                    .text("-1")
        var ColorScaleLabel2 = CanvasColorScale.append('text')
                    .attr("x", 190)
                    .attr("y", 110)
                    .attr("dy", ".35em")
                    .text("1")
        var ColorScaleLabel2 = CanvasColorScale.append('text')
                    .attr("x", 70)
                    .attr("y", 110)
                    .attr("dy", ".35em")
                    .text("Sentiment")

    </script>
  </body>
</html>
